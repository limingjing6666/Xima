<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xima.app.mapper.GroupMemberMapper">

    <resultMap id="GroupMemberResultMap" type="com.xima.app.entity.GroupMember">
        <id property="id" column="id"/>
        <result property="groupId" column="group_id"/>
        <result property="userId" column="user_id"/>
        <result property="nickname" column="nickname"/>
        <result property="role" column="role" typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result property="muted" column="muted"/>
        <result property="joinTime" column="join_time"/>
    </resultMap>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO group_member (group_id, user_id, nickname, role, muted)
        VALUES (#{groupId}, #{userId}, #{nickname}, #{role, typeHandler=org.apache.ibatis.type.EnumTypeHandler}, #{muted})
    </insert>

    <insert id="batchInsert">
        INSERT INTO group_member (group_id, user_id, nickname, role, muted) VALUES
        <foreach collection="members" item="member" separator=",">
            (#{member.groupId}, #{member.userId}, #{member.nickname}, #{member.role, typeHandler=org.apache.ibatis.type.EnumTypeHandler}, #{member.muted})
        </foreach>
    </insert>

    <select id="findByGroupIdAndUserId" resultMap="GroupMemberResultMap">
        SELECT * FROM group_member WHERE group_id = #{groupId} AND user_id = #{userId}
    </select>

    <select id="findMembersByGroupId" resultType="com.xima.app.dto.group.GroupMemberDTO">
        SELECT 
            u.id as userId,
            u.username,
            u.nickname,
            u.avatar,
            gm.nickname as groupNickname,
            gm.role,
            gm.muted,
            gm.join_time as joinTime,
            u.status
        FROM group_member gm
        INNER JOIN user u ON gm.user_id = u.id
        WHERE gm.group_id = #{groupId}
        ORDER BY 
            CASE gm.role 
                WHEN 'OWNER' THEN 1 
                WHEN 'ADMIN' THEN 2 
                ELSE 3 
            END,
            gm.join_time ASC
    </select>

    <select id="findMemberIdsByGroupId" resultType="java.lang.Long">
        SELECT user_id FROM group_member WHERE group_id = #{groupId}
    </select>

    <update id="update">
        UPDATE group_member
        <set>
            <if test="nickname != null">nickname = #{nickname},</if>
            <if test="role != null">role = #{role},</if>
            <if test="muted != null">muted = #{muted},</if>
        </set>
        WHERE group_id = #{groupId} AND user_id = #{userId}
    </update>

    <delete id="deleteByGroupIdAndUserId">
        DELETE FROM group_member WHERE group_id = #{groupId} AND user_id = #{userId}
    </delete>

    <delete id="deleteByGroupId">
        DELETE FROM group_member WHERE group_id = #{groupId}
    </delete>

    <select id="countByGroupId" resultType="int">
        SELECT COUNT(*) FROM group_member WHERE group_id = #{groupId}
    </select>

    <select id="isMember" resultType="boolean">
        SELECT COUNT(*) > 0 FROM group_member WHERE group_id = #{groupId} AND user_id = #{userId}
    </select>

    <select id="findTopMemberAvatars" resultType="java.lang.String">
        SELECT u.avatar
        FROM group_member gm
        INNER JOIN user u ON gm.user_id = u.id
        WHERE gm.group_id = #{groupId}
        ORDER BY 
            CASE gm.role 
                WHEN 'OWNER' THEN 1 
                WHEN 'ADMIN' THEN 2 
                ELSE 3 
            END,
            gm.join_time ASC
        LIMIT #{limit}
    </select>

    <update id="updateRole">
        UPDATE group_member SET role = #{role} WHERE group_id = #{groupId} AND user_id = #{userId}
    </update>

    <update id="updateMuted">
        UPDATE group_member SET muted = #{muted} WHERE group_id = #{groupId} AND user_id = #{userId}
    </update>

    <select id="findGroupIdsByUserId" resultType="java.lang.Long">
        SELECT group_id FROM group_member WHERE user_id = #{userId}
    </select>

</mapper>
