<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xima.app.mapper.FriendshipMapper">

    <!-- 好友关系结果映射 -->
    <resultMap id="FriendshipResultMap" type="com.xima.app.entity.Friendship">
        <id property="id" column="id"/>
        <result property="userId" column="user_id"/>
        <result property="friendId" column="friend_id"/>
        <result property="status" column="status" typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result property="remark" column="remark"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <!-- 根据ID查询 -->
    <select id="findById" resultMap="FriendshipResultMap">
        SELECT * FROM friendship WHERE id = #{id}
    </select>

    <!-- 查询两个用户之间的好友关系 -->
    <select id="findByUserIdAndFriendId" resultMap="FriendshipResultMap">
        SELECT * FROM friendship 
        WHERE user_id = #{userId} AND friend_id = #{friendId}
    </select>

    <!-- 查询用户的所有好友（已接受状态） -->
    <!-- 每个用户有自己的记录，user_id是当前用户，friend_id是好友 -->
    <select id="findFriendsByUserId" resultMap="FriendshipResultMap">
        SELECT * FROM friendship 
        WHERE user_id = #{userId} 
        AND status = 'ACCEPTED'
    </select>

    <!-- 查询用户收到的好友请求（待处理） -->
    <select id="findPendingRequestsByFriendId" resultMap="FriendshipResultMap">
        SELECT * FROM friendship 
        WHERE friend_id = #{friendId} AND status = 'PENDING'
        ORDER BY create_time DESC
    </select>

    <!-- 查询用户发出的好友请求 -->
    <select id="findSentRequestsByUserId" resultMap="FriendshipResultMap">
        SELECT * FROM friendship 
        WHERE user_id = #{userId} AND status = 'PENDING'
        ORDER BY create_time DESC
    </select>

    <!-- 插入好友关系 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO friendship (user_id, friend_id, status, create_time, update_time)
        VALUES (#{userId}, #{friendId}, #{status}, NOW(), NOW())
    </insert>

    <!-- 更新好友关系状态 -->
    <update id="updateStatus">
        UPDATE friendship SET status = #{status}, update_time = NOW() WHERE id = #{id}
    </update>

    <!-- 删除好友关系 -->
    <delete id="deleteById">
        DELETE FROM friendship WHERE id = #{id}
    </delete>

    <!-- 删除两个用户之间的好友关系 -->
    <delete id="deleteByUserIdAndFriendId">
        DELETE FROM friendship 
        WHERE (user_id = #{userId} AND friend_id = #{friendId})
           OR (user_id = #{friendId} AND friend_id = #{userId})
    </delete>

    <!-- 检查是否已经是好友或有待处理请求 -->
    <select id="existsFriendship" resultType="boolean">
        SELECT COUNT(*) > 0 FROM friendship 
        WHERE ((user_id = #{userId} AND friend_id = #{friendId})
           OR (user_id = #{friendId} AND friend_id = #{userId}))
        AND status IN ('PENDING', 'ACCEPTED')
    </select>

    <!-- 统计用户好友数量 -->
    <select id="countFriends" resultType="long">
        SELECT COUNT(*) FROM friendship 
        WHERE user_id = #{userId} 
        AND status = 'ACCEPTED'
    </select>

    <!-- 查询用户所有好友的ID列表 -->
    <select id="findFriendIdsByUserId" resultType="java.lang.Long">
        SELECT friend_id
        FROM friendship 
        WHERE user_id = #{userId} 
        AND status = 'ACCEPTED'
    </select>

    <!-- 更新好友备注（只更新当前用户的记录） -->
    <update id="updateRemark">
        UPDATE friendship 
        SET remark = #{remark}, update_time = NOW()
        WHERE user_id = #{userId} AND friend_id = #{friendId}
        AND status = 'ACCEPTED'
    </update>

    <!-- 获取好友备注（只查询当前用户的记录） -->
    <select id="getRemark" resultType="java.lang.String">
        SELECT remark FROM friendship 
        WHERE user_id = #{userId} AND friend_id = #{friendId}
        AND status = 'ACCEPTED'
    </select>

</mapper>
