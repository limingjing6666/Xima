# Xima 性能测试指南

## 1. 内置性能测试

### 运行方式
```bash
cd src/backend/xima-app
mvn test -Dtest=PerformanceTest
```

### 测试项目
| 测试项 | 请求次数 | 预期响应时间 |
|--------|----------|--------------|
| 健康检查 | 100 | < 1000ms |
| 登录接口 | 20 | < 1000ms |
| 并发登录 | 50 (10用户×5请求) | 成功率 > 95% |
| 获取好友列表 | 50 | < 1000ms |
| 获取聊天历史 | 50 | < 1000ms |
| 搜索用户 | 30 | < 1000ms |

## 2. JMeter 压力测试

### 安装 JMeter
1. 下载: https://jmeter.apache.org/download_jmeter.cgi
2. 解压并配置环境变量

### 测试场景配置

#### 场景1: 登录压测
```
线程组配置:
- 线程数: 100
- Ramp-Up: 10秒
- 循环次数: 10

HTTP请求:
- 方法: POST
- 路径: /api/v1/auth/login
- Body: {"username":"testuser","password":"password123"}
- Content-Type: application/json
```

#### 场景2: 消息查询压测
```
线程组配置:
- 线程数: 50
- Ramp-Up: 5秒
- 循环次数: 20

HTTP请求:
- 方法: GET
- 路径: /api/v1/messages/history/2
- Header: Authorization: Bearer ${token}
```

#### 场景3: 混合场景压测
```
线程组1 (登录): 20线程
线程组2 (好友列表): 30线程
线程组3 (消息查询): 50线程
```

### 性能指标
| 指标 | 目标值 |
|------|--------|
| 平均响应时间 | < 500ms |
| 95%响应时间 | < 1000ms |
| 99%响应时间 | < 2000ms |
| 错误率 | < 1% |
| 吞吐量 | > 100 req/s |

## 3. 数据库性能优化

### 已添加索引
```sql
-- message 表
ALTER TABLE message ADD INDEX idx_message_sender_receiver (sender_id, receiver_id);
ALTER TABLE message ADD INDEX idx_message_receiver_status (receiver_id, status);
ALTER TABLE message ADD INDEX idx_message_create_time (create_time);

-- friendship 表
ALTER TABLE friendship ADD INDEX idx_friendship_user_id (user_id);
ALTER TABLE friendship ADD INDEX idx_friendship_friend_id (friend_id);
ALTER TABLE friendship ADD INDEX idx_friendship_status (status);

-- user 表
ALTER TABLE user ADD INDEX idx_user_username (username);
ALTER TABLE user ADD INDEX idx_user_email (email);
ALTER TABLE user ADD INDEX idx_user_status (status);
```

### 执行优化脚本
```bash
mysql -u root -p xima < src/backend/xima-app/src/main/resources/db/performance_optimization.sql
```

## 4. 监控指标

### 应用监控
- JVM 内存使用
- GC 频率和时间
- 线程池状态
- 数据库连接池状态

### 系统监控
- CPU 使用率
- 内存使用率
- 磁盘 I/O
- 网络带宽

## 5. 性能优化建议

### 短期优化
1. ✅ 数据库索引优化
2. ✅ 分页查询
3. 连接池配置调优
4. 启用 Redis 缓存

### 长期优化
1. 读写分离
2. 分库分表
3. 消息队列异步处理
4. CDN 静态资源加速
